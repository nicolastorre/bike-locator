this.templates=this.templates||{},this.templates.bikelocator=Handlebars.template({1:function(a,b,c,d,e){var f=a.lambda,g=a.escapeExpression;return'                        <option value="'+g(f(null!=b?b.name:b,b))+'">'+g(f(null!=b?b.name:b,b))+"</option>\n"},compiler:[7,">= 4.0.0"],main:function(a,b,c,d,e){var f;return'<div id="search-box" class="container">\n    <div id="form-locator" class="container well">\n        <form>\n            <div class="form-group row">\n                <div class="col-sm-2">\n                    <label for="search-location" class="form-control-label">Location</label>\n                    <input type="text" id="search-location" name="location" class="form-control" >\n                </div>\n                <div class="col-sm-2">\n                    <label for="distance" class="form-control-label">Distance</label>\n                    <select class="form-control" id="distance" name="distance">\n                        <option value="none">None</option>\n                        <option value="0.5">500 m</option>\n                        <option value="1">1 km</option>\n                        <option value="5">5 km</option>\n                        <option value="10">10 km</option>\n                        <option value="15">15 km</option>\n                    </select>\n                </div>\n                <div class="col-sm-2">\n                    <label for="contract" class="form-control-label">City</label>\n                    <select class="form-control" id="contract" name="contract">\n                        <option value="all" selected="selected">All</option>\n'+(null!=(f=c.each.call(null!=b?b:{},null!=b?b.contracts:b,{name:"each",hash:{},fn:a.program(1,e,0),inverse:a.noop,data:e}))?f:"")+'\n                    </select>\n                </div>\n                <button type="button" id="search-button" class="col-sm-2 btn btn-primary">Search</button>\n            </div>\n            <div class="form-group row">\n                <div class="col-sm-2">\n                    <label for="min-available-bike" class="form-control-label">Min available bike</label>\n                </div>\n                <div class="col-sm-2">\n                    <div id="min-available-bike" class="slider"></div>\n                </div>\n            </div>\n            <div class="form-group row">\n                <div class="col-sm-2">\n                    <label for="min-free-stand" class="form-control-label">Min free stand</label>\n                </div>\n                <div class="col-sm-2">\n                    <div id="min-free-stand" class="slider"></div>\n                </div>\n            </div>\n        </form>\n    </div>\n</div>\n<div class="container">\n    <div class="row">\n        <div id="list-velib" class="col-sm-3">\n        </div>\n        <div id="map-canvas" class="col-sm-9"></div>\n    </div>\n</div>'},useData:!0}),this.templates.emptyresult=Handlebars.template({compiler:[7,">= 4.0.0"],main:function(a,b,c,d,e){return'<div id="stations-list-panel" class="panel panel-default stations-list-panel">\n    <div class="panel-heading">\n        <h3>0 bike stations</h3>\n    </div>\n    <div class="panel-body stations-list">\n    </div>\n</div>'},useData:!0}),this.templates.stationdetail=Handlebars.template({compiler:[7,">= 4.0.0"],main:function(a,b,c,d,e){var f,g=a.lambda,h=a.escapeExpression;return'<div id="detail-station" class="panel panel-default">\n    <div class="panel-heading">\n        <h3 class="panel-title">Details<button type="button" class="btn-close btn btn-danger btn-xs"><span class="glyphicon glyphicon-remove"></span></button></h3>\n    </div>\n    <div class="detail panel-body">\n        <h4>'+h(g(null!=(f=null!=b?b.station:b)?f.name:f,b))+"</h4>\n        <address>\n            "+h(g(null!=(f=null!=b?b.station:b)?f.address:f,b))+" "+h(g(null!=(f=null!=b?b.station:b)?f.city:f,b))+" "+h(g(null!=(f=null!=b?b.station:b)?f.country:f,b))+"\n        </address>\n        <p>Bike stands: "+h(g(null!=(f=null!=b?b.station:b)?f.bike_stands:f,b))+"</p>\n        <p>Available bikes: "+h(g(null!=(f=null!=b?b.station:b)?f.available_bikes:f,b))+"</p>\n        <p>Available bike stands: "+h(g(null!=(f=null!=b?b.station:b)?f.available_bike_stands:f,b))+"</p>\n    </div>\n</div>"},useData:!0}),this.templates.stationlist=Handlebars.template({1:function(a,b,c,d,e){var f=a.lambda,g=a.escapeExpression;return'            <li data-station="'+g(f(null!=b?b.number:b,b))+'" data-contract="'+g(f(null!=b?b.contract_name:b,b))+'" class="station">\n                <strong>'+g(f(null!=b?b.name:b,b))+"</strong>\n						<span>\n							"+g(f(null!=b?b.address:b,b))+" <br/> "+g(f(null!=b?b.postcode:b,b))+" "+g(f(null!=b?b.city:b,b))+" <br/>\n							<!--<a href='#' class='directions'>Get directions</a>-->\n						</span>\n                <hr/>\n            </li>\n"},compiler:[7,">= 4.0.0"],main:function(a,b,c,d,e){var f;return'<div id="stations-list-panel" class="panel panel-default stations-list-panel">\n    <div class="panel-heading">\n        <h3>'+a.escapeExpression(a.lambda(null!=(f=null!=b?b.stations:b)?f.length:f,b))+' bike stations</h3>\n    </div>\n    <div class="panel-body stations-list">\n        <ul id="stations-list">\n'+(null!=(f=c.each.call(null!=b?b:{},null!=b?b.stations:b,{name:"each",hash:{},fn:a.program(1,e,0),inverse:a.noop,data:e}))?f:"")+"        </ul>\n    </div>\n</div>"},useData:!0}),function(a){"use strict";var b=Stapes.subclass({constructor:function(){this.$el=a("#locator"),this.model=new c,this.model.requestContracts(),this.view=new d,this.event()},initDeferredSearch:function(){var b=this;this.geocodingEvent=a.Deferred(),this.listStationsEvent=a.Deferred(),a.when(this.geocodingEvent,this.listStationsEvent).done(function(){b.model.sortByDistanceBikeAndStand()})},event:function(b){var c=this;c.$el.on("requestedContracts",function(){c.view.initTemplate(c.model.contracts)}),c.$el.on("click","#search-button",function(){c.model.geocode(),c.model.request()}),this.initDeferredSearch(),c.$el.on("geocoded",function(a){c.geocodingEvent.resolve()}),c.$el.on("requested",function(a){c.listStationsEvent.resolve()}),c.$el.on("showListMap",function(a){0==c.model.stations.length?c.view.emptyResultView():(c.view.listView(c.model.stations),c.view.mapView(c.model.stations)),c.initDeferredSearch()}),c.$el.on("click",".station",function(b){var d=a(b.target),e=d.closest(".station").data("station"),f=d.closest(".station").data("contract");c.model.requestCurrentStation(e,f),google.maps.event.trigger(c.view.velibMarkers[e],"clickDetail")}),c.$el.on("showDetail",function(b,d,e){a(b.target);console.log(e),c.model.requestCurrentStation(d,e)}),c.$el.on("requestedCurrentStation",function(){c.view.detailView(c.model.currentStation)}),c.$el.on("click",".btn-close",function(a){c.view.closeInfoWindow(),c.view.closeDetailStation()}),c.$el.on("listView",function(){c.view.closeInfoWindow(),c.view.closeDetailStation()})}}),c=Stapes.subclass({constructor:function(){this.$el=a("#locator"),this.velibURL="https://api.jcdecaux.com/vls/v1/stations",this.contractURL="https://api.jcdecaux.com/vls/v1/contracts",this.stationURL="https://api.jcdecaux.com/vls/v1/stations/",this.location=null,this.apiKey="15c9f9a03c7c9a67d4287fd82e04bf6d775719ad",this.stations={},this.currentStation=null,this.contracts=null,this.ajaxStatus=!1},query:function(){var b={};return"all"!=a("#contract").val()&&(b.contract=a("#contract").val()),b.apiKey=this.apiKey,b},geocode:function(){var b=this,c=new google.maps.Geocoder,d=a("#search-location").val();d.length>0?c.geocode({address:d},function(a,c){c===google.maps.GeocoderStatus.OK?(b.location=a[0].geometry.location,console.log("Position: lat: "+b.location.lat()+"lng: "+b.location.lat())):alert("Geocode was not successful for the following reason: "+c),b.$el.trigger("geocoded")}):b.$el.trigger("geocoded")},request:function(b){var c,d=this;this.ajaxStatus||(this.ajaxStatus=!0,this.renderSpinner(),c=this.query(),a.ajax({url:d.velibURL,data:c,success:function(a){d.stations=a,d.$el.trigger("requested"),d.ajaxStatus=!1,d.removeSpinner()},error:function(a,b,c){alert("Erreur API JC Decaux Velib!")}}))},requestContracts:function(){var b,c=this;this.ajaxStatus||(this.ajaxStatus=!0,this.renderSpinner(),b={apiKey:this.apiKey},a.ajax({url:c.contractURL,data:b,success:function(a){c.contracts=a.sort(function(a,b){var c=a.name.toUpperCase(),d=b.name.toUpperCase();return d>c?-1:c>d?1:0}),c.$el.trigger("requestedContracts"),c.ajaxStatus=!1,c.removeSpinner()},error:function(a,b,c){alert("Erreur API JC Decaux Velib!")}}))},requestCurrentStation:function(b,c){var d,e,f=this;this.ajaxStatus||(this.ajaxStatus=!0,this.renderSpinner(),e=f.stationURL+b,d={contract:c,apiKey:this.apiKey},a.ajax({url:e,data:d,success:function(a){f.currentStation=a,f.$el.trigger("requestedCurrentStation"),f.ajaxStatus=!1,f.removeSpinner()},error:function(a,b,c){alert("Erreur API JC Decaux Velib!")}}))},toRadian:function(a){return a*(Math.PI/180)},diffRadian:function(a,b){return this.toRadian(b)-this.toRadian(a)},distance:function(a,b,c,d){var e=6367;return 2*e*Math.asin(Math.min(1,Math.sqrt(Math.pow(Math.sin(this.diffRadian(a,c)/2),2)+Math.cos(this.toRadian(a))*Math.cos(this.toRadian(c))*Math.pow(Math.sin(this.diffRadian(b,d)/2),2))))},sortByDistanceBikeAndStand:function(){var b=this,c=a("#distance").val(),d=a("#min-available-bike").slider("value"),e=a("#min-free-stand").slider("value"),f=[];"none"!=c&&null!=b.location?a.each(b.stations,function(a,g){b.distance(g.position.lat,g.position.lng,b.location.lat(),b.location.lng())<=c&&g.available_bikes>=d&&g.available_bike_stands>=e&&f.push(b.stations[a])}):a.each(b.stations,function(a,c){c.available_bikes>=d&&c.available_bike_stands>=e&&f.push(b.stations[a])}),b.stations=f,b.$el.trigger("showListMap")},renderSpinner:function(){this.$el.toggleClass("loading")},removeSpinner:function(){this.$el.removeClass("loading")}}),d=Stapes.subclass({constructor:function(){this.$el=a("#locator"),this.map,this.infowindow,this.velibMarkers},getTemplate:function(b,c){if(3==arguments.length)var d=arguments[2];else d=[];var e=templates[b](d);a(c).append(e)},initTemplate:function(b){var c=this,d={contracts:b};this.getTemplate("bikelocator",c.$el,d),a(".slider").slider({value:0,min:0,max:50,step:5});var e=new google.maps.places.Autocomplete(document.getElementById("search-location"),{types:["geocode"]});google.maps.event.addListener(e,"place_changed",function(){})},mapView:function(b){var c,d,e=this;e.velibMarkers=[],a("#map-canvas").length&&a("#map-canvas").empty();var f={zoom:5};e.map=new google.maps.Map(document.getElementById("map-canvas"),f);var g=new google.maps.LatLngBounds;e.infowindow=new google.maps.InfoWindow;var h={gridSize:50,maxZoom:15},i=new MarkerClusterer(e.map,[],h);a.each(b,function(a,b){c=new google.maps.LatLng(b.position.lat,b.position.lng),d=new google.maps.Marker({position:c,title:b.name}),e.velibMarkers[b.number]=d,google.maps.event.addListener(e.velibMarkers[b.number],"click",function(a){e.closeDetailStation(),e.infowindow.setContent("Bike station: "+b.name),e.infowindow.open(e.map,this),e.$el.trigger("showDetail",[b.number,b.contract_name]),google.maps.event.addListener(e.infowindow,"closeclick",function(){e.$el.trigger("listView")})}),google.maps.event.addListener(e.velibMarkers[b.number],"clickDetail",function(a){e.closeDetailStation(),c=new google.maps.LatLng(b.position.lat,b.position.lng),e.infowindow.setContent("Bike station: "+b.name),e.infowindow.setPosition(c),e.infowindow.open(e.map,this),google.maps.event.addListener(e.infowindow,"closeclick",function(){e.$el.trigger("listView")})}),d.setMap(e.map),i.addMarker(d,!0),g.extend(c)}),e.map.fitBounds(g)},listView:function(b){var c=this;this.$list=a("#list-velib"),this.$list.empty();var d={stations:b};this.getTemplate("stationlist",c.$list,d)},detailView:function(b){var c=this;this.$stationsListPanel=a("#stations-list-panel"),this.$stationsListPanel.hide();var d={station:b};this.getTemplate("stationdetail",c.$list,d)},emptyResultView:function(){var b=this;this.$list=a("#list-velib"),b.$list.length&&b.$list.empty(),a("#map-canvas").length&&(a("#map-canvas").empty(),a("#map-canvas").css("background-color","rgb(255,255,255)"));var c={};this.getTemplate("emptyresult",b.$list,c)},closeInfoWindow:function(){this.infowindow.close()},closeDetailStation:function(){this.$stationsListPanel=a("#stations-list-panel"),this.$detailStation=a("#detail-station"),this.$detailStation.remove(),this.$stationsListPanel.show()},renderSpinner:function(){this.$el.toggleClass("loading")},removeSpinner:function(){this.$el.removeClass("loading")}});a(document).ready(function(){new b})}(jQuery);